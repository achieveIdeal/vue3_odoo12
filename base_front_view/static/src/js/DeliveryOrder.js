import{R as e,E as a,c as t}from"./RecordView.js";import{E as i}from"./el-overlay.js";import{_ as r}from"./PageHeader.js";import{d as o,r as l,o as s,e as d,i as n,f as u,c as _,a as m,w as c,u as p,g as h,F as v,h as y,t as f,j as g,b,_ as w}from"./index.js";const C=o({__name:"MatchPo",emits:["loadedCallback","customClick"],setup(a,{emit:t}){const i=parseInt(n("supplier_id")||0),r=l({id:0,type:"list",title:"匹配采购订单",name:"delivery_order",limit:20,offset:0,domain:[["partner_id","=",i]],sort:"id desc",count:0,model:"match.purchase.order",fields:["product_id","product_name","amount_planned","partner_id","match_line_ids","comment"],tables:{match_line_ids:{title:"匹配明细行",limit:10,offset:0,domain:[],sort:"id desc",count:0,model:"match.purchase.order.line",fields:["purchase_order_id","purchase_order_name","purchase_order_line_id","amount","uom_id"]}}}),o={buttons:[{type:"custom",method:"save_match_po",showType:["form"],classify:"primary",text:"保存",show:!0,attributes:{}},{type:"custom",method:"cancel",show:!0,showType:["form"],text:"取消",attributes:{}}],attributes:{match_line_ids:{undel:!0,unadd:!0,fields:{readonly:["product_id","product_name","amount_planned","partner_id","match_line_ids"],invisible:["purchase_order_name"],amount:{sum:!0}}}},readonly:["product_id","product_name","amount_planned","partner_id","match_line_ids"]},u=(e,a,i)=>{i(),t("loadedCallback",e,a)},_=(e,a,i,r)=>{t("customClick",e,a,i,r)};return(a,t)=>(s(),d(e,{params:r,extras:o,onLoadedCallable:u,onCustomClick:_},null,8,["params"]))}}),k=o({__name:"MatchCode",emits:["loadedCallback","selectClick"],setup(a,{emit:t}){const i=parseInt(n("supplier_id")||0);u("");const r=l({classify:"list",title:"匹配赋码",name:"delivery_order",hideDetail:!0,domain:[["supplier_id","=",i],["delivery_order_line_id","=",!1],["if_print","=",!0],["is_generate","=",!0]],count:0,height:270,model:"srm.coding",fields:["name","default_code","product_name","produce_number","amount","min_pack_size","date_from","shelf_life","manufacturer_id"],tables:{}}),o={buttons:[{type:"custom",method:"save_match_code",showType:["list"],classify:"primary",text:"保存",show:!0,attributes:{}},{type:"custom",method:"cancel",show:!0,showType:["list"],text:"取消",attributes:{}}],search_fields:{date_from:{},name:{}},attributes:{amount:{sum:!0},name:{width:200}},readonly:["name","default_code","product_name","produce_number","amount","min_pack_size","date_from","shelf_life","manufacturer_id"]},_=(e,a,i)=>{i(),t("loadedCallback",e,a)},m=(e,a)=>{t("selectClick",e,a)};return(a,t)=>(s(),d(e,{params:r,extras:o,onSelectClick:m,onLoadedCallable:_},null,8,["params"]))}}),x={class:"code-total"},j=w(o({__name:"DeliveryOrder",setup(o){const d=parseInt(n("supplier_id")||0);let w=g(),j=!1,q=u({}),O=u(!1),T=u(!1),D=u({}),L={},V={},I=[],R=u({}),M=u(0);const z=l({title:"交货单",name:"delivery_order",width:"30%",domain:[["partner_id","=",d]],model:"srm.delivery.order",fields:["name","partner_id","expect_date","company_id","h_state","submit_user_id","state","jit_flag","line_ids"],tables:{line_ids:{title:"交货订单行",model:"srm.delivery.order.line",fields:["product_id","material_name","jit_id","shortage_id","amount_planned","delivery_quantity","uom_id","purchase_order","code_names","comment","origin_data_ids"]}}}),E={buttons:[{type:"object",method:"button_print",showType:["list","form"],text:"打印",needRow:!0,attributes:{invisible:[["state","in",["create","destroy"]]]}},{type:"object",method:"action_cancel",classify:"danger",showType:["list","form"],text:"作废",needRow:!0,attributes:{invisible:[["state","in",["create","done","destroy"]]]}},{type:"custom",method:"action_submit",showType:["form"],classify:"primary",text:"提交",show:!0,attributes:{invisible:[["state","!=","create"]]}},{type:"custom",method:"cancel",showType:["form"],text:"取消",show:!0,attributes:{invisible:[["state","!=","create"]]}}],hideDetail:!0,search_fields:{expect_date:{},state:{}},attributes:{line_ids:{unadd:!0,fields:{readonly:["product_id","material_name","uom_id","purchase_order","code_names","amount_planned"],invisible:["jit_id","shortage_id","origin_data_ids"],amount_planned:{sum:!0},product_id:{string:"物料编码",width:140},material_name:{string:"物料描述"},delivery_quantity:{sum:!0,readonly:[["line_ids.purchase_order","!=",""]],min:0}},buttons:[{method:"match_po",text:"匹配采购单",attributes:{invisible:[["state","!=","create"]]}},{method:"match_code",text:"匹配赋码",attributes:{invisible:[["state","!=","create"]]}}]},name:{width:170},partner_id:{width:200},company_id:{width:220}},readonly:["name","partner_id","expect_date","company_id","h_state","submit_user_id","state"],invisible:["h_state"],listInvisible:["h_state"]},F=e=>{const a=e||q.value,t=a.origin_data_ids;R.value[t]=[],L[t]=[],a.code_names=""},P=e=>{const a=(e||q.value).origin_data_ids,t=D.value[a];D.value[a]=[];const i=(null==t?void 0:t.length)?t[0].match_line_ids:[];for(const r of i||[]){const e=r[2];V[e.purchase_order_line_id]-=e.amount,e.purchase_type_id&&I.splice(I.indexOf(e.purchase_type_id),1)}},S=(e,i,r,o)=>{var l,s;if("action_submit"===e.method){for(const e of Object.keys(D.value||{}))if(!q.value.purchase_order||!(null==(l=D.value[e])?void 0:l.length)||!(null==(s=R.value[e])?void 0:s.length))return a({message:"请先匹配数据在提交!",type:"error"}),!1;if(!Object.keys(D.value).length||!Object.keys(R.value).length)return a({message:"请先匹配数据在提交!",type:"error"}),!1;o.value=!0,t({model:z.model,method:"action_submit",args:[i,{po_datas:D.value,code_datas:R.value}]}).then((e=>{if(e.error)return o.value=!1,a({message:e.error.data.message,type:"error"}),!1;o.value=!1,b.replace({name:z.name,query:{id:e.result.id}})}))}else"cancel"===e.method&&b.push({name:"shortage_product"})},U=async(e,i,r)=>{var o;let l=null==(o=w.query)?void 0:o.plan_ids;if(l||(null==l?void 0:l.length)){r(),l=l instanceof Array?l:[l],i.value=!0;const o=await t({model:z.model,method:"prepare_create",args:[l]});if(o.error)return i.value=!1,a({message:o.error.data.message,type:"error"}),b.back(),!1;i.value=!1,e(o.result)}},A=(e,t,i)=>{var r;if(q.value=t,"match_po"===i.method)O.value=!0;else if("match_code"===i.method){if(M.value=0,!(null==(r=null==D?void 0:D.value[q.value.origin_data_ids])?void 0:r.length))return a({message:"请先匹配采购订单!",type:"error"}),!1;T.value=!0}},B=async(e,i)=>{const r=q.value.origin_data_ids;P(),F(),q.value.delivery_quantity||(q.value.delivery_quantity=Math.abs(q.value.amount_planned)),i.value=!0;const o=await t({model:z.model,method:"match_po",args:[r,q.value.delivery_quantity,V,j,I]});if(o.error)return i.value=!1,a({message:o.error.data.message,type:"error"}),q.value.delivery_quantity=0,O.value=!1,!1;i.value=!1;const l=o.result;l.formData.comment=q.value.comment,e(l)},H=async(e,i)=>{const r=q.value.origin_data_ids;F(),i.value=!0;let o=[];for(const a of Object.values(L))o=o.concat(a);const l=await t({model:z.model,method:"match_code",args:[r,q.value.delivery_quantity,o,j]});if(l.error)return i.value=!1,a({message:l.error.data.message,type:"error"}),O.value=!1,!1;i.value=!1;const s=[["id","not in",o],["default_code","=",q.value.product_id]];e(l.result,s)},G=(e,a)=>{if("cancel"===e.method)q.value.comment="",q.value.purchase_order="",P();else{!D.value[q.value.origin_data_ids]&&(D.value[q.value.origin_data_ids]=[]),D.value[q.value.origin_data_ids].push(a);const e=a.match_line_ids;let t=0;for(const a of e){const e=a[2];!V[e.purchase_order_line_id]&&(V[e.purchase_order_line_id]=0),V[e.purchase_order_line_id]+=e.amount,t+=e.amount,e.purchase_type_id&&I.push(e.purchase_type_id)}q.value.comment=a.comment,q.value.delivery_quantity=t,q.value.purchase_order=a.match_line_ids.map((e=>e[2].purchase_order_name)).join(",")}O.value=!1},J=(e,t)=>{if("cancel"===e.method)F(),q.value.code_names="";else{if(!Object.keys(t||{}).length)return a({message:"请选择一条记录!",type:"error"}),!1;if(q.value.delivery_quantity!=M.value)return a({message:"赋码数量与交货数量不相等，请重新选择!",type:"error"}),!1;!R.value[q.value.origin_data_ids]&&(R.value[q.value.origin_data_ids]=[]),R.value[q.value.origin_data_ids].push(t),L[q.value.origin_data_ids]=(t||[]).map((e=>e.id)),q.value.code_names=(t||[]).map((e=>e.name)).join(",")}T.value=!1},K=(e,a,t)=>{F(t),P(t),delete R.value[t.origin_data_ids],delete D.value[t.origin_data_ids]},N=e=>{M.value=0;for(const a of e)M.value+=a.amount},Q=(e,a)=>{const t=e.field,i=e.datas;"jit_flag"===t&&(j=i.jit_flag,D=u({}),L={},V={},I=[],R=u({}),M=u(0))};return(a,t)=>{const o=r,l=i;return s(),_(v,null,[m(o,{title:"交货单"}),m(l,{modelValue:p(O),"onUpdate:modelValue":t[0]||(t[0]=e=>h(O)?O.value=e:O=e),title:"匹配采购订单",width:"50%",draggable:"","destroy-on-close":"",modal:""},{default:c((()=>[m(C,{onLoadedCallback:B,onCustomClick:G,isDialog:!0})])),_:1},8,["modelValue"]),m(l,{modelValue:p(T),"onUpdate:modelValue":t[1]||(t[1]=e=>h(T)?T.value=e:T=e),title:"匹配赋码信息",width:"70%",draggable:"","destroy-on-close":"",style:{height:"500px",overflow:"scroll"},modal:""},{default:c((()=>[m(k,{onLoadedCallback:H,onCustomClick:J,onSelectClick:N,isDialog:!0}),y("span",x,"选中总数："+f(p(M)),1)])),_:1},8,["modelValue"]),m(e,{params:z,extras:E,onLoadedCallable:U,onLineButtonClick:A,onDeleteLineClick:K,onFieldOnchange:Q,onCustomClick:S},null,8,["params"])],64)}}}),[["__scopeId","data-v-e32c1708"]]);export{j as default};
